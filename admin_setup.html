<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Setup | CMCS VLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-cmcs-blue { background-color: #0070c0; }
        .bg-cmcs-sidebar { background-color: #00b0f0; }
        .bg-cmcs-yellow { background-color: #ffff00; }
        .bg-cmcs-logout { background-color: #cc0000; }
        
        .sidebar-link { padding: 12px 20px; display: block; color: white; font-weight: bold; text-transform: uppercase; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .active-tab { background-color: #ffff00; color: black; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 5px; }
        th { background-color: #d9d9d9; border: 1px solid #7f7f7f; padding: 6px; text-align: left; font-weight: bold; }
        td { border: 1px solid #7f7f7f; padding: 6px; background-color: #ffffff; }
        
        .btn-action { text-decoration: underline; cursor: pointer; font-weight: bold; margin-right: 8px; }
        .text-edit { color: #0070c0; }
        .text-delete { color: #cc0000; }

        .modal-overlay { background-color: rgba(0,0,0,0.6); position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-container { background: white; border: 2px solid black; width: 450px; padding: 0; box-shadow: 6px 6px 0px 0px black; }
        .modal-header { background-color: #0070c0; color: white; padding: 10px; font-weight: bold; font-size: 13px; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; }
        .modal-label { display: block; font-size: 10px; font-weight: bold; margin-bottom: 2px; text-transform: uppercase; }
        .modal-input, .modal-select { width: 100%; border: 1px solid #7f7f7f; padding: 6px; font-size: 11px; margin-bottom: 12px; outline: none; background: white; }
        .modal-footer { padding: 12px; display: flex; justify-content: flex-end; gap: 8px; background: #f0f0f0; border-top: 1px solid #7f7f7f; }
        
        .btn-modal-save { background-color: #ffff00; border: 1px solid black; padding: 6px 20px; font-size: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-modal-cancel { background-color: #d9d9d9; border: 1px solid black; padding: 6px 20px; font-size: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        
        .loading-btn { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-white min-h-screen flex flex-col font-sans">

    <nav class="bg-cmcs-blue text-white flex justify-between items-center h-12">
        <div class="px-4 font-bold text-sm">CMCS Virtual Learning System</div>
        <div class="flex items-center h-full">
            <div class="px-6 text-xs uppercase italic"><span id="adminName">Admin</span></div>
            <button onclick="logout()" class="bg-cmcs-logout h-full px-8 text-white font-bold text-xs">LOGOUT</button>
        </div>
    </nav>

    <div class="flex flex-1">
        <aside class="w-48 bg-cmcs-sidebar flex flex-col">
            <a href="admin_approval.html" class="sidebar-link">APPROVALS</a>
            <a href="admin_setup.html" class="sidebar-link active-tab">ACADEMIC SETUP</a>
            <a href="admin_class.html" class="sidebar-link">CLASS ASSIGNMENT</a>
            <a href="admin_records.html" class="sidebar-link">MASTER RECORD</a>
        </aside>

        <main class="flex-1 p-6">
            <div class="mb-10">
                <div class="flex justify-between items-end mb-2">
                    <h2 class="text-[12px] font-bold uppercase">COURSES</h2>
                    <button onclick="openEntryModal('course')" class="bg-cmcs-yellow border border-black px-3 py-1 text-[10px] font-bold">+ ADD NEW COURSE</button>
                </div>
                <table>
                    <thead><tr><th width="25%">COURSE NAME</th><th width="10%">YRS</th><th>DESCRIPTION</th><th width="15%">ACTIONS</th></tr></thead>
                    <tbody id="courseTableBody"></tbody>
                </table>
            </div>

            <div>
                <div class="flex justify-between items-end mb-2">
                    <h2 class="text-[12px] font-bold uppercase">SUBJECT PROGRAM</h2>
                    <button onclick="openEntryModal('subject')" class="bg-cmcs-yellow border border-black px-3 py-1 text-[10px] font-bold">+ ADD SUBJECT</button>
                </div>
                <table>
                    <thead><tr><th>CODE</th><th>SUBJECT</th><th>YEAR</th><th>SEM</th><th>FACULTY</th><th>ACTIONS</th></tr></thead>
                    <tbody id="programTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="entryModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header"><span id="modalTitle">ENTRY</span><span class="cursor-pointer" onclick="closeModal('entryModal')">X</span></div>
            <form id="entryForm">
                <input type="hidden" id="targetColl">
                <input type="hidden" id="editId">
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer">
                    <button type="submit" id="submitBtn" class="btn-modal-save">SAVE RECORD</button>
                    <button type="button" class="btn-modal-cancel" onclick="closeModal('entryModal')">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div id="sysModal" class="modal-overlay">
        <div class="modal-container w-80 text-center">
            <div class="modal-header"><span>SYSTEM NOTIFICATION</span></div>
            <div class="modal-body"><p id="sysMsg" class="font-bold text-xs uppercase"></p></div>
            <div class="modal-footer justify-center" id="sysFooter"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
    apiKey: "AIzaSy...",
    authDomain: "svls-289ee.firebaseapp.com",
    projectId: "svls-289ee",
    storageBucket: "svls-289ee.firebasestorage.app",
    messagingSenderId: "500705386198",
    appId: "1:500705386198:web:96f189662bc2aa99cf7377"
};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- UNIFIED MODAL LOGIC ---
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        
        window.showSysMsg = (msg, onConfirm = null) => {
            document.getElementById('sysMsg').innerText = msg;
            const footer = document.getElementById('sysFooter');
            footer.innerHTML = '';
            
            if (onConfirm) {
                const yesBtn = document.createElement('button');
                yesBtn.className = "btn-modal-save";
                yesBtn.innerText = "CONFIRM";
                yesBtn.onclick = () => { onConfirm(); closeModal('sysModal'); };
                footer.appendChild(yesBtn);
                
                const noBtn = document.createElement('button');
                noBtn.className = "btn-modal-cancel";
                noBtn.innerText = "BACK";
                noBtn.onclick = () => closeModal('sysModal');
                footer.appendChild(noBtn);
            } else {
                footer.innerHTML = `<button onclick="closeModal('sysModal')" class="btn-modal-save">OKAY</button>`;
            }
            document.getElementById('sysModal').style.display = 'flex';
        };

        // --- AUTH & LOADING ---
        onAuthStateChanged(auth, async (user) => {
            if (user) { loadData(); } else { window.location.href = "login.html"; }
        });

        async function loadData() {
            const cTable = document.getElementById('courseTableBody');
            const pTable = document.getElementById('programTableBody');
            cTable.innerHTML = ''; pTable.innerHTML = '';

            const courses = await getDocs(collection(db, "courses"));
            courses.forEach(d => {
                cTable.innerHTML += `<tr><td>${d.data().name}</td><td>${d.data().duration}</td><td>${d.data().desc}</td>
                <td><span class="btn-action text-edit" onclick="editRec('courses', '${d.id}')">Edit</span>
                <span class="btn-action text-delete" onclick="askDelete('courses', '${d.id}')">Delete</span></td></tr>`;
            });

            const progs = await getDocs(collection(db, "programs"));
            progs.forEach(d => {
                pTable.innerHTML += `<tr><td class="font-bold">${d.data().code}</td><td>${d.data().name}</td><td>${d.data().year}</td><td>${d.data().semester}</td><td>${d.data().teacher}</td>
                <td><span class="btn-action text-edit" onclick="editRec('programs', '${d.id}')">Edit</span>
                <span class="btn-action text-delete" onclick="askDelete('programs', '${d.id}')">Delete</span></td></tr>`;
            });
        }

        // --- FORM HANDLING ---
        window.openEntryModal = async (type, data = null, id = "") => {
            const body = document.getElementById('modalBody');
            document.getElementById('targetColl').value = type === 'course' ? 'courses' : 'programs';
            document.getElementById('editId').value = id;
            document.getElementById('modalTitle').innerText = (id ? "EDIT " : "ADD NEW ") + type.toUpperCase();
            
            if(type === 'course') {
                body.innerHTML = `
                    <label class="modal-label">Course Name</label><input type="text" id="f1" class="modal-input" value="${data?.name || ''}" required>
                    <label class="modal-label">Duration</label><input type="number" id="f2" class="modal-input" value="${data?.duration || ''}" required>
                    <label class="modal-label">Description</label><textarea id="f3" class="modal-input h-20" required>${data?.desc || ''}</textarea>`;
            } else {
                const teachers = await getDocs(query(collection(db, "users"), where("role", "==", "teacher"), where("status", "==", "approved")));
                let options = teachers.docs.map(t => `<option value="${t.data().lastname}" ${data?.teacher === t.data().lastname ? 'selected' : ''}>${t.data().lastname}</option>`).join('');
                body.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="modal-label">Code</label><input type="text" id="f1" class="modal-input" value="${data?.code || ''}" required></div>
                        <div><label class="modal-label">Subject</label><input type="text" id="f2" class="modal-input" value="${data?.name || ''}" required></div>
                        <div><label class="modal-label">Year</label><select id="f3" class="modal-select">${[1,2,3,4].map(v => `<option value="${v}" ${data?.year == v ? 'selected' : ''}>${v}</option>`).join('')}</select></div>
                        <div><label class="modal-label">Semester</label><select id="f4" class="modal-select">${[1,2].map(v => `<option value="${v}" ${data?.semester == v ? 'selected' : ''}>${v}</option>`).join('')}</select></div>
                    </div>
                    <label class="modal-label">Teacher</label><select id="f5" class="modal-select" required>${options}</select>`;
            }
            document.getElementById('entryModal').style.display = 'flex';
        };

        document.getElementById('entryForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.classList.add('loading-btn');

            const coll = document.getElementById('targetColl').value;
            const id = document.getElementById('editId').value;
            let payload = coll === 'courses' ? 
                { name: document.getElementById('f1').value, duration: document.getElementById('f2').value, desc: document.getElementById('f3').value } :
                { code: document.getElementById('f1').value, name: document.getElementById('f2').value, year: document.getElementById('f3').value, semester: document.getElementById('f4').value, teacher: document.getElementById('f5').value };

            // Logic: Block same exact record (Code for subjects, Name for courses)
            const fieldToCheck = coll === 'courses' ? 'name' : 'code';
            const check = await getDocs(query(collection(db, coll), where(fieldToCheck, "==", payload[fieldToCheck])));
            
            if(!id && !check.empty) {
                showSysMsg("DUPLICATE ERROR: THIS RECORD ALREADY EXISTS.");
            } else if(id) {
                await updateDoc(doc(db, coll, id), payload);
                showSysMsg("RECORD UPDATED SUCCESSFULLY.");
            } else {
                await addDoc(collection(db, coll), payload);
                showSysMsg("RECORD SAVED SUCCESSFULLY.");
            }

            closeModal('entryModal'); loadData();
            btn.classList.remove('loading-btn');
        };

        window.editRec = async (coll, id) => {
            const d = (await getDoc(doc(db, coll, id))).data();
            openEntryModal(coll === 'courses' ? 'course' : 'subject', d, id);
        };

        window.askDelete = (coll, id) => showSysMsg("ARE YOU SURE YOU WANT TO DELETE THIS?", async () => {
            await deleteDoc(doc(db, coll, id));
            loadData();
        });

        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
    </script>
</body>
</html>
