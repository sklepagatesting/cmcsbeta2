<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Faculty Dashboard | CMCS VLS</title>    <script src="https://cdn.tailwindcss.com"></script>    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    <script>        tailwind.config = {            theme: {                extend: {                    fontFamily: { sans: ['Inter', 'sans-serif'] },                    colors: { primary: '#2563eb', secondary: '#1e293b', success: '#10b981', danger: '#ef4444' }                }            }        }    </script>    <style>        .scrollbar-hide::-webkit-scrollbar { display: none; }        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #2563eb; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }        .active-nav { background: #2563eb !important; color: white !important; shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }                @media print {            body * { visibility: hidden; }            #printArea, #printArea * { visibility: visible; }            #printArea { position: absolute; left: 0; top: 0; width: 100%; border:none; shadow:none; }            .no-print { display: none !important; }            .print-header { display: flex !important; }        }    </style></head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex overflow-hidden">
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div id="modalContent" class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center">
            <div id="modalIcon" class="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl"></div>
            <h3 id="modalTitle" class="text-xl font-bold mb-2"></h3>
            <p id="modalBody" class="text-gray-500 text-sm mb-6"></p>
            <button onclick="closeModal()" class="px-6 py-2 bg-gray-100 rounded-lg font-bold text-xs uppercase">Close</button>
        </div>
    </div>

    <aside class="w-64 bg-secondary text-white flex flex-col shadow-2xl z-20 no-print">
        <div class="h-16 flex items-center px-6 border-b border-gray-700 bg-slate-900">
            <div class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-graduation-cap text-primary"></i> CMCS <span class="text-primary">VLS</span></div>
        </div>
        <nav class="flex-1 py-6 px-3 space-y-1 overflow-y-auto" id="subjectNav"></nav>
        <div class="p-4 border-t border-gray-700 bg-slate-900">
            <div class="flex items-center gap-3 mb-3 p-2">
                <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center font-bold" id="adminInitial"></div>
                <div class="flex-1 min-w-0"><p class="text-xs font-bold truncate" id="adminName"></p></div>
            </div>
            <button onclick="logout()" class="w-full bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white py-2 rounded-md text-xs font-bold uppercase tracking-widest transition-all">Logout</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="h-16 bg-white shadow-sm flex items-center justify-between px-8 z-10 no-print">
            <h1 id="activeSubjectTitle" class="text-xl font-bold text-gray-800">Select Subject</h1>
            <div class="flex items-center gap-4">
                <div id="viewToggles" class="hidden bg-gray-100 p-1 rounded-lg flex gap-1">
                    <button id="btnAtt" onclick="switchView('attendance')" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all active-nav">Attendance</button>
                    <button id="btnGrd" onclick="switchView('grades')" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all text-gray-500">Grades</button>
                    <button id="btnMat" onclick="switchView('materials')" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all text-gray-500">Materials</button>
                </div>
                <button onclick="saveCurrentWork()" id="saveBtn" class="hidden bg-primary text-white px-5 py-2 rounded-lg text-xs font-bold uppercase shadow-md flex items-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up"></i> SYNC DATA
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 scrollbar-hide">
            <div id="placeholder" class="h-full flex items-center justify-center text-gray-400">Select a subject to begin</div>
            
            <div id="workspace" class="hidden space-y-6">
                <div class="bg-white rounded-xl border overflow-hidden shadow-sm no-print">
                    <table class="w-full text-[11px] uppercase font-bold text-left">
                        <tr class="bg-gray-50 border-b text-gray-400"><th class="px-4 py-2">Course</th><th class="px-4 py-2">Sched</th><th class="px-4 py-2">Time</th><th class="px-4 py-2">Sem</th><th class="px-4 py-2">Year</th></tr>
                        <tr><td id="detCourse" class="px-4 py-3 border-r"></td><td id="detSched" class="px-4 py-3 border-r"></td><td id="detTime" class="px-4 py-3 border-r"></td><td id="detSem" class="px-4 py-3 border-r"></td><td id="detYear" class="px-4 py-3"></td></tr>
                    </table>
                </div>

                <div id="printArea" class="space-y-4">
                    <div class="hidden print-header flex-col items-center mb-6 text-center border-b-2 border-black pb-4">
                        <h2 class="text-2xl font-black uppercase">Central Mindanao Computer School</h2>
                        <p class="text-xs font-bold uppercase" id="printSubjInfo"></p>
                    </div>

                    <div id="materialUploadSection" class="hidden bg-white p-6 rounded-xl border no-print shadow-sm">
                        <form id="materialForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="hidden" id="editMatId">
                            <input type="text" id="matName" placeholder="TITLE" class="text-xs border rounded p-2 uppercase" required>
                            <input type="url" id="matLink" placeholder="URL" class="text-xs border rounded p-2" required>
                            <input type="datetime-local" id="matSchedule" class="text-xs border rounded p-2" required>
                            <textarea id="matDesc" placeholder="DESC" class="md:col-span-2 text-xs border rounded p-2"></textarea>
                            <button type="submit" class="bg-secondary text-white rounded text-xs font-bold uppercase">Upload</button>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div id="tableHeader" class="px-6 py-4 border-b flex justify-between items-center bg-gray-50/50 no-print"></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse" id="mainDataTable">
                                <thead id="tableHead" class="bg-gray-50 text-[10px] uppercase font-bold border-b"></thead>
                                <tbody id="tableBody" class="divide-y text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDaeNQF4qmW0vvwxUPp_NztnT0hoLzm1BQ", authDomain: "svls-289ee.firebaseapp.com", projectId: "svls-289ee", storageBucket: "svls-289ee.firebasestorage.app", messagingSenderId: "500705386198", appId: "1:500705386198:web:96f189662bc2aa99cf7377" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        
        let roster = [], activeSubj = "", currentView = "attendance", currentTeacher = "", searchTerm = "";

        onAuthStateChanged(auth, async user => {
            if (!user) return window.location.href="login.html";
            const snap = await getDoc(doc(db, "users", user.uid));
            if (snap.exists()) {
                currentTeacher = `${snap.data().lastname}, ${snap.data().firstname}`.toUpperCase();
                document.getElementById('adminName').innerText = currentTeacher;
                document.getElementById('adminInitial').innerText = snap.data().firstname[0] + snap.data().lastname[0];
                loadPrograms();
            }
        });

        async function loadPrograms() {
            const q = query(collection(db, "programs"), where("teacher", "==", currentTeacher));
            const snap = await getDocs(q);
            const nav = document.getElementById('subjectNav');
            nav.innerHTML = '<p class="px-3 text-xs font-bold text-gray-400 uppercase mb-2">Subjects</p>';
            snap.forEach(d => {
                const s = d.data();
                const btn = document.createElement('div');
                btn.className = "p-3 rounded-lg text-sm cursor-pointer hover:bg-gray-700 transition-all mb-1";
                btn.innerText = s.code;
                btn.onclick = () => selectSubject(s, btn);
                nav.appendChild(btn);
            });
        }

        async function selectSubject(s, el) {
            activeSubj = s.code;
            document.querySelectorAll('#subjectNav div').forEach(b => b.classList.remove('bg-primary'));
            el.classList.add('bg-primary');
            document.getElementById('activeSubjectTitle').innerText = s.name;
            document.getElementById('detCourse').innerText = s.course;
            document.getElementById('detSched').innerText = s.schedule;
            document.getElementById('detTime').innerText = `${s.startTime}-${s.endTime}`;
            document.getElementById('detSem').innerText = s.semester;
            document.getElementById('detYear').innerText = s.year;
            document.getElementById('printSubjInfo').innerText = `${s.code} - ${s.name} | ${s.course} ${s.year}`;
            
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('workspace').classList.remove('hidden');
            document.getElementById('viewToggles').classList.remove('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');

            const q = query(collection(db, "users"), where("role", "==", "student"), where("assignedPrograms", "array-contains", s.code));
            const snap = await getDocs(q);
            roster = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        }

        window.switchView = (v) => {
            currentView = v;
            ['btnAtt', 'btnGrd', 'btnMat'].forEach(id => {
                const b = document.getElementById(id);
                const isActive = id.toLowerCase().includes(v.substring(0,3));
                b.className = `px-4 py-1.5 text-xs font-bold rounded-md transition-all ${isActive ? 'active-nav' : 'text-gray-500'}`;
            });
            document.getElementById('materialUploadSection').classList.toggle('hidden', v !== 'materials');
            renderTable();
        };

        window.renderTable = () => {
            const head = document.getElementById('tableHead');
            const hInfo = document.getElementById('tableHeader');
            const today = new Date().toISOString().split('T')[0];

            hInfo.innerHTML = `
                <div class="flex gap-4 items-center">
                    ${currentView === 'attendance' ? `<input type="date" id="attDate" max="${today}" value="${today}" onchange="renderTableBody()" class="text-xs bg-gray-100 p-1 rounded font-bold">` : ''}
                    <input type="text" placeholder="Search..." oninput="searchTerm=this.value.toLowerCase();renderTableBody()" class="text-xs bg-gray-100 p-1.5 rounded-lg outline-none w-40">
                </div>
                <div class="flex gap-2">
                    <button onclick="exportCSV()" class="text-[10px] border px-3 py-1 rounded font-bold uppercase hover:bg-gray-100">CSV</button>
                    <button onclick="window.print()" class="text-[10px] border px-3 py-1 rounded font-bold uppercase hover:bg-gray-100">PDF</button>
                </div>`;

            if (currentView === 'attendance') {
                head.innerHTML = `<tr><th class="px-6 py-4">Student</th><th class="px-6 py-4 text-center">Gender</th><th class="px-6 py-4 text-center">Status</th></tr>`;
            } else if (currentView === 'grades') {
                head.innerHTML = `<tr><th class="px-6 py-4">Student</th><th class="px-6 py-4 text-center">PRE</th><th class="px-6 py-4 text-center">MID</th><th class="px-6 py-4 text-center">FIN</th><th class="px-6 py-4 text-right">PT</th></tr>`;
            } else {
                head.innerHTML = `<tr><th class="px-6 py-4">Title</th><th class="px-6 py-4">Link</th><th class="px-6 py-4 text-right">Actions</th></tr>`;
            }
            renderTableBody();
        };

        window.renderTableBody = () => {
            const body = document.getElementById('tableBody'); body.innerHTML = '';
            const filtered = roster.filter(s => `${s.firstname} ${s.lastname}`.toLowerCase().includes(searchTerm));

            if (currentView === 'attendance') {
                const date = document.getElementById('attDate')?.value || new Date().toISOString().split('T')[0];
                filtered.forEach(s => {
                    const st = s.attendance?.[activeSubj]?.[date] || 'P';
                    body.innerHTML += `<tr><td class="px-6 py-4 font-bold uppercase">${s.lastname}, ${s.firstname}</td><td class="px-6 py-4 text-center text-xs text-gray-400 font-bold">${s.gender || '-'}</td><td class="px-6 py-4 text-center"><div class="flex justify-center gap-4 text-xs font-bold"><label><input type="radio" name="att_${s.id}" value="P" ${st==='P'?'checked':''}> P</label><label><input type="radio" name="att_${s.id}" value="L" ${st==='L'?'checked':''}> L</label><label><input type="radio" name="att_${s.id}" value="A" ${st==='A'?'checked':''}> A</label></div></td></tr>`;
                });
            } else if (currentView === 'grades') {
                filtered.forEach(s => {
                    const g = s.grades?.[activeSubj] || { prelim:0, midterm:0, final:0, point:5.0 };
                    body.innerHTML += `<tr><td class="px-6 py-4 font-bold uppercase">${s.lastname}, ${s.firstname}</td><td class="px-6 py-4 text-center"><input type="number" oninput="liveCalc('${s.id}')" id="pre_${s.id}" value="${g.prelim}" class="w-12 bg-gray-100 text-center rounded"></td><td class="px-6 py-4 text-center"><input type="number" oninput="liveCalc('${s.id}')" id="mid_${s.id}" value="${g.midterm}" class="w-12 bg-gray-100 text-center rounded"></td><td class="px-6 py-4 text-center"><input type="number" oninput="liveCalc('${s.id}')" id="fin_${s.id}" value="${g.final}" class="w-12 bg-gray-100 text-center rounded"></td><td id="pt_${s.id}" class="px-6 py-4 text-right font-black text-primary">${g.point}</td></tr>`;
                });
            } else {
                onSnapshot(query(collection(db, "materials"), where("subjectCode", "==", activeSubj)), snap => {
                    body.innerHTML = '';
                    snap.forEach(d => {
                        const m = d.data();
                        body.innerHTML += `<tr class="text-xs"><td class="px-6 py-4 font-bold uppercase">${m.name}</td><td class="px-6 py-4"><a href="${m.link}" target="_blank" class="text-primary font-bold underline">URL</a></td><td class="px-6 py-4 text-right flex justify-end gap-3"><button onclick="editMat('${d.id}')" class="text-primary"><i class="fa-solid fa-pen"></i></button><button onclick="deleteMat('${d.id}')" class="text-danger"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                    });
                });
            }
        };

        window.liveCalc = (sid) => {
            const p = parseFloat(document.getElementById(`pre_${sid}`).value || 0);
            const m = parseFloat(document.getElementById(`mid_${sid}`).value || 0);
            const f = parseFloat(document.getElementById(`fin_${sid}`).value || 0);
            const avg = (p+m+f)/3;
            let pt = 5.0;
            if(avg>=95) pt=1.0; else if(avg>=90) pt=1.5; else if(avg>=85) pt=2.0; else if(avg>=80) pt=2.5; else if(avg>=75) pt=3.0;
            document.getElementById(`pt_${sid}`).innerText = pt;
        };

        window.saveCurrentWork = async () => {
            const btn = document.getElementById('saveBtn'); const old = btn.innerHTML;
            btn.innerHTML = '<span class="loader mr-2"></span> SYNCING...'; btn.disabled = true;
            try {
                for(let s of roster) {
                    if(currentView === 'grades') {
                        await updateDoc(doc(db, "users", s.id), { [`grades.${activeSubj}`]: { 
                            prelim: document.getElementById(`pre_${s.id}`).value, 
                            midterm: document.getElementById(`mid_${s.id}`).value, 
                            final: document.getElementById(`fin_${s.id}`).value,
                            point: document.getElementById(`pt_${s.id}`).innerText 
                        }});
                    } else if (currentView === 'attendance') {
                        const date = document.getElementById('attDate').value;
                        const status = document.querySelector(`input[name="att_${s.id}"]:checked`).value;
                        await updateDoc(doc(db, "users", s.id), { [`attendance.${activeSubj}.${date}`]: status });
                    }
                }
                showAlert("Success", "Synced successfully.");
            } catch(e) { showAlert("Error", "Fail."); } finally { btn.innerHTML = old; btn.disabled = false; }
        };

        window.exportCSV = () => {
            let csv = "Name,Gender,Record\n";
            roster.forEach(s => csv += `${s.lastname} ${s.firstname},${s.gender || '-'}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${activeSubj}.csv`; a.click();
        };

        // --- Materials Logic Restored ---
        const matForm = document.getElementById('materialForm');
        matForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editMatId').value;
            const data = { 
                name: document.getElementById('matName').value, 
                link: document.getElementById('matLink').value, 
                schedule: document.getElementById('matSchedule').value, 
                description: document.getElementById('matDesc').value, 
                subjectCode: activeSubj 
            };
            if(id) await updateDoc(doc(db, "materials", id), data);
            else await setDoc(doc(collection(db, "materials")), data);
            matForm.reset(); document.getElementById('editMatId').value = "";
            showAlert("Success", "Material Updated.");
        };

        window.deleteMat = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "materials", id)); };
        window.editMat = async (id) => {
            const snap = await getDoc(doc(db, "materials", id));
            const m = snap.data();
            document.getElementById('editMatId').value = id;
            document.getElementById('matName').value = m.name;
            document.getElementById('matLink').value = m.link;
            document.getElementById('matSchedule').value = m.schedule;
            document.getElementById('matDesc').value = m.description;
        };

        window.showAlert = (t, m) => {
            document.getElementById('modalTitle').innerText = t;
            document.getElementById('modalBody').innerText = m;
            document.getElementById('modalOverlay').classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');
        window.logout = () => signOut(auth).then(()=>window.location.href="login.html");
    </script>
</body></html>
