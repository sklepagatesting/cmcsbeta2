<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Assignment | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black min-h-screen pb-32">
    <div class="max-w-6xl mx-auto p-6">
        <h2 class="text-4xl font-black mb-8 border-b-8 border-black pb-2 uppercase italic">Class_Assignment</h2>

        <div class="bg-black text-white p-4 mb-8 flex flex-wrap gap-4 items-end">
            <div>
                <label class="text-[10px] font-bold block mb-1">FILTER BY COURSE</label>
                <select id="filterCourse" class="bg-white text-black p-2 outline-none font-bold">
                    <option value="BSIT">BSIT</option>
                    <option value="BSCS">BSCS</option>
                </select>
            </div>
            <div>
                <label class="text-[10px] font-bold block mb-1">YEAR</label>
                <select id="filterYear" class="bg-white text-black p-2 outline-none font-bold">
                    <option value="1">1st Year</option><option value="2">2nd Year</option>
                    <option value="3">3rd Year</option><option value="4">4th Year</option>
                </select>
            </div>
            <div>
                <label class="text-[10px] font-bold block mb-1">SEMESTER</label>
                <select id="filterSem" class="bg-white text-black p-2 outline-none font-bold">
                    <option value="1">1st Sem</option><option value="2">2nd Sem</option>
                </select>
            </div>
            <button onclick="loadStudents()" class="bg-gray-700 px-6 py-2 font-black hover:bg-white hover:text-black transition">FILTER LIST</button>
        </div>

        <div class="border-4 border-black overflow-hidden shadow-[10px_10px_0px_0px_rgba(0,0,0,1)]">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100 border-b-4 border-black">
                    <tr>
                        <th class="p-4 border-r-2 border-black">ID / Name</th>
                        <th class="p-4 border-r-2 border-black">Assigned Subjects</th>
                        <th class="p-4">Action</th>
                    </tr>
                </thead>
                <tbody id="studentClassBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="subjectModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-white border-4 border-black p-8 max-w-md w-full">
            <h3 class="text-2xl font-black mb-4 uppercase">Assign Subjects</h3>
            <div id="subjectList" class="space-y-2 mb-6 max-h-60 overflow-y-auto">
                </div>
            <div class="flex gap-2">
                <button onclick="saveAssignments()" class="flex-1 bg-black text-white py-3 font-bold">SAVE CHANGES</button>
                <button onclick="closeModal()" class="flex-1 border-2 border-black py-3 font-bold">CANCEL</button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full flex gap-6 shadow-2xl z-50">
        <a href="admin_dashboard.html" class="text-xs font-bold hover:text-gray-400">HOME</a>
        <a href="admin_approval.html" class="text-xs font-bold hover:text-gray-400">APPROVALS</a>
        <a href="admin_setup.html" class="text-xs font-bold hover:text-gray-400">SETUP</a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

            const firebaseConfig = { 
        apiKey: "AIzaSyDaeNQF4qmW0vvwxUPp_NztnT0hoLzm1BQ",
        authDomain: "svls-289ee.firebaseapp.com",
        projectId: "svls-289ee",
        storageBucket: "svls-289ee.firebasestorage.app",
        messagingSenderId: "500705386198",
        appId: "1:500705386198:web:96f189662bc2aa99cf7377"
    };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentStudentId = null;

        window.loadStudents = async () => {
            const body = document.getElementById('studentClassBody');
            body.innerHTML = '<tr><td colspan="3" class="p-10 text-center font-bold">Fetching students...</td></tr>';
            
            const q = query(collection(db, "users"), 
                where("role", "==", "student"),
                where("status", "==", "approved"),
                where("course", "==", document.getElementById('filterCourse').value),
                where("year", "==", document.getElementById('filterYear').value)
            );

            const snap = await getDocs(q);
            body.innerHTML = '';

            snap.forEach(s => {
                const data = s.data();
                const subjects = data.subjects ? data.subjects.join(", ") : '<span class="italic text-gray-400">None Assigned</span>';
                body.innerHTML += `
                    <tr class="border-b-2 border-black hover:bg-gray-50">
                        <td class="p-4 border-r-2 border-black">
                            <div class="font-black">${data.lastname}, ${data.firstname}</div>
                            <div class="text-xs font-mono">${data.studentId}</div>
                        </td>
                        <td class="p-4 border-r-2 border-black text-sm">${subjects}</td>
                        <td class="p-4">
                            <button onclick="openSubjectPicker('${s.id}')" class="bg-black text-white px-4 py-2 text-xs font-bold">EDIT SUBJECTS</button>
                        </td>
                    </tr>`;
            });
        };

        window.openSubjectPicker = async (uid) => {
            currentStudentId = uid;
            const list = document.getElementById('subjectList');
            list.innerHTML = 'Loading subjects...';
            document.getElementById('subjectModal').classList.remove('hidden');

            const q = query(collection(db, "programs"), 
                where("year", "==", document.getElementById('filterYear').value),
                where("semester", "==", document.getElementById('filterSem').value)
            );
            const snap = await getDocs(q);
            list.innerHTML = '';

            snap.forEach(p => {
                list.innerHTML += `
                    <label class="flex items-center gap-3 p-2 border-2 border-black cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" name="subj" value="${p.data().code}" class="w-5 h-5 accent-black">
                        <span class="font-bold">${p.data().code} - ${p.data().name}</span>
                    </label>`;
            });
        };

        window.saveAssignments = async () => {
            const selected = Array.from(document.querySelectorAll('input[name="subj"]:checked')).map(cb => cb.value);
            await updateDoc(doc(db, "users", currentStudentId), {
                subjects: selected
            });
            closeModal();
            loadStudents();
        };

        window.closeModal = () => document.getElementById('subjectModal').classList.add('hidden');

        // Initial Load
        loadStudents();
    </script>
</body>
</html>
