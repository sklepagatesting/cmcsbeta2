<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approvals | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black min-h-screen pb-32">

    <div id="msgModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
        <div class="bg-white border-4 border-black p-8 max-w-sm w-full shadow-[10px_10px_0px_0px_rgba(0,0,0,1)] text-center">
            <h3 id="modalTitle" class="font-black text-2xl mb-2 uppercase">System Message</h3>
            <p id="modalMsg" class="font-medium text-gray-700 mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-black text-white py-3 font-bold hover:bg-gray-800 transition uppercase">Understood</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-6">
        <h2 class="text-4xl font-black mb-8 border-b-8 border-black pb-2 italic">PENDING_APPROVALS</h2>

        <section class="mb-12">
            <h3 class="text-xl font-bold bg-black text-white px-4 py-1 inline-block mb-4 uppercase">Teacher Requests</h3>
            <div class="overflow-x-auto border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b-2 border-black">
                        <tr class="text-xs uppercase font-black">
                            <th class="p-3 border-r-2 border-black">Name</th>
                            <th class="p-3 border-r-2 border-black">Gender</th>
                            <th class="p-3 border-r-2 border-black">Email</th>
                            <th class="p-3 border-r-2 border-black">Designation</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="teacherTableBody"></tbody>
                </table>
            </div>
        </section>

        <section>
            <h3 class="text-xl font-bold bg-black text-white px-4 py-1 inline-block mb-4 uppercase">Student Requests</h3>
            <div class="overflow-x-auto border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b-2 border-black">
                        <tr class="text-xs uppercase font-black">
                            <th class="p-3 border-r-2 border-black">Name</th>
                            <th class="p-3 border-r-2 border-black">Course/Year</th>
                            <th class="p-3 border-r-2 border-black">Gender</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDaeNQF4qmW0vvwxUPp_NztnT0hoLzm1BQ",
            authDomain: "svls-289ee.firebaseapp.com",
            projectId: "svls-289ee",
            storageBucket: "svls-289ee.firebasestorage.app",
            messagingSenderId: "500705386198",
            appId: "1:500705386198:web:96f189662bc2aa99cf7377"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // MODAL LOGIC
        window.showModal = (title, msg) => {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerText = msg;
            document.getElementById('msgModal').classList.remove('hidden');
        }

        window.closeModal = () => {
            document.getElementById('msgModal').classList.add('hidden');
        }

        // APPROVAL LOGIC
        window.handleUser = async (uid, action) => {
            try {
                const userRef = doc(db, "users", uid);
                if (action === 'approve') {
                    await updateDoc(userRef, { status: "approved" });
                    showModal("SUCCESS", "Account has been officially approved.");
                } else {
                    await deleteDoc(userRef);
                    showModal("REMOVED", "Account request has been declined.");
                }
                loadPendingUsers();
            } catch (error) {
                showModal("PERMISSION ERROR", error.message);
            }
        };

        async function loadPendingUsers() {
            const tBody = document.getElementById('teacherTableBody');
            const sBody = document.getElementById('studentTableBody');
            tBody.innerHTML = ''; sBody.innerHTML = '';

            const q = query(collection(db, "users"), where("status", "==", "pending"));
            const snap = await getDocs(q);

            if (snap.empty) {
                tBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center italic">All caught up! No pending teachers.</td></tr>';
                sBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center italic">All caught up! No pending students.</td></tr>';
                return;
            }

            snap.forEach((u) => {
                const d = u.data();
                const id = u.id;
                if (d.role === 'teacher') {
                    tBody.innerHTML += `
                        <tr class="border-b-2 border-black hover:bg-gray-50">
                            <td class="p-3 border-r-2 border-black font-bold">${d.lastname}, ${d.firstname}</td>
                            <td class="p-3 border-r-2 border-black">${d.gender || 'N/A'}</td>
                            <td class="p-3 border-r-2 border-black text-xs font-mono">${d.email}</td>
                            <td class="p-3 border-r-2 border-black">${d.designation}</td>
                            <td class="p-3 flex gap-2">
                                <button onclick="handleUser('${id}', 'approve')" class="bg-black text-white px-3 py-1 text-xs font-bold hover:bg-green-600 transition">APPROVE</button>
                                <button onclick="handleUser('${id}', 'decline')" class="border-2 border-black px-3 py-1 text-xs font-bold hover:bg-red-600 hover:text-white transition">DECLINE</button>
                            </td>
                        </tr>`;
                } else {
                    sBody.innerHTML += `
                        <tr class="border-b-2 border-black hover:bg-gray-50">
                            <td class="p-3 border-r-2 border-black font-bold">${d.lastname}, ${d.firstname}</td>
                            <td class="p-3 border-r-2 border-black">${d.course} - Yr ${d.year}</td>
                            <td class="p-3 border-r-2 border-black">${d.gender || 'N/A'}</td>
                            <td class="p-3 flex gap-2">
                                <button onclick="handleUser('${id}', 'approve')" class="bg-black text-white px-3 py-1 text-xs font-bold hover:bg-green-600 transition">APPROVE</button>
                                <button onclick="handleUser('${id}', 'decline')" class="border-2 border-black px-3 py-1 text-xs font-bold hover:bg-red-600 hover:text-white transition">DECLINE</button>
                            </td>
                        </tr>`;
                }
            });
        }

        loadPendingUsers();
    </script>
</body>
</html>
