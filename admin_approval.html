<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approvals | CMCS VLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Exact Colors from Guidelines */
        .bg-cmcs-blue { background-color: #0070c0; }
        .bg-cmcs-sidebar { background-color: #00b0f0; }
        .bg-cmcs-yellow { background-color: #ffff00; }
        .bg-cmcs-logout { background-color: #cc0000; }
        
        .sidebar-link {
            padding: 12px 20px;
            display: block;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
        }
        .active-tab { background-color: #ffff00; color: black; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background-color: #d9d9d9; border: 1px solid #7f7f7f; padding: 4px; text-align: left; }
        td { border: 1px solid #7f7f7f; padding: 4px; }
        .btn-approve { color: #22c55e; font-weight: bold; cursor: pointer; }
        .btn-decline { color: #cc0000; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body class="bg-white min-h-screen flex flex-col font-sans">

    <nav class="bg-cmcs-blue text-white flex justify-between items-center h-12 shadow-sm">
        <div class="flex items-center px-4 gap-2">
            <span class="font-bold text-sm">[Logo] CMCS Virtual Learning System</span>
        </div>
        <div class="flex items-center h-full">
            <div class="flex gap-4 px-6 items-center">
                <span id="adminName" class="font-bold text-xs uppercase">Lastname, Firstname</span>
                <span id="adminEmail" class="font-bold text-xs">Email@gmail.com</span>
            </div>
            <button onclick="logout()" class="bg-cmcs-logout h-full px-8 text-white font-bold text-xs">Logout</button>
        </div>
    </nav>

    <div class="flex flex-1">
        <aside class="w-48 bg-cmcs-sidebar flex flex-col">
            <a href="admin_approval.html" class="sidebar-link active-tab">APPROVALS</a>
            <a href="admin_setup.html" class="sidebar-link">ACADEMIC SETUP</a>
            <a href="admin_class.html" class="sidebar-link">CLASS ASSIGNMENT</a>
            <a href="admin_records.html" class="sidebar-link">MASTER RECORD</a>
        </aside>

        <main class="flex-1 p-4">
            
            <div class="mb-8">
                <div class="bg-cmcs-yellow border border-black px-2 py-0.5 w-full">
                    <h2 class="text-[10px] font-bold uppercase">STUDENT REQUEST</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>LASTNAME</th>
                            <th>FIRSTNAME</th>
                            <th>EMAIL</th>
                            <th>ADDRESS</th>
                            <th>COURSE</th>
                            <th>YEAR</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="studentTable">
                        </tbody>
                </table>
            </div>

            <div>
                <div class="bg-cmcs-yellow border border-black px-2 py-0.5 w-full">
                    <h2 class="text-[10px] font-bold uppercase">FACULTY REQUEST</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>LASTNAME</th>
                            <th>FIRSTNAME</th>
                            <th>EMAIL</th>
                            <th>ADDRESS</th>
                            <th>COURSE</th>
                            <th>YEAR</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="facultyTable">
                        </tbody>
                </table>
            </div>

        </main>
    </div>

    <footer class="bg-cmcs-blue text-white p-4">
        <p class="text-[10px]">Copyright 2026 CMCS. All Rights Reserved</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDaeNQF4qmW0vvwxUPp_NztnT0hoLzm1BQ",
            authDomain: "svls-289ee.firebaseapp.com",
            projectId: "svls-289ee",
            storageBucket: "svls-289ee.firebasestorage.app",
            messagingSenderId: "500705386198",
            appId: "1:500705386198:web:96f189662bc2aa99cf7377"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('adminName').innerText = `${data.lastname}, ${data.firstname}`;
                    document.getElementById('adminEmail').innerText = user.email;
                    loadRequests();
                }
            } else { window.location.href = "login.html"; }
        });

        async function loadRequests() {
            const sTable = document.getElementById('studentTable');
            const fTable = document.getElementById('facultyTable');
            sTable.innerHTML = ''; fTable.innerHTML = '';

            const q = query(collection(db, "users"), where("status", "==", "pending"));
            const snap = await getDocs(q);

            snap.forEach(u => {
                const d = u.data();
                const row = `
                    <tr>
                        <td class="uppercase">${d.lastname}</td>
                        <td class="uppercase">${d.firstname}</td>
                        <td class="text-blue-600 underline">${d.email}</td>
                        <td>${d.address || 'Mlang, Cotabato'}</td>
                        <td>${d.course || 'BSIT'}</td>
                        <td>${d.year || '1'}</td>
                        <td>
                            <span onclick="updateStatus('${u.id}', 'approved')" class="btn-approve">Approve</span>
                            <span onclick="updateStatus('${u.id}', 'declined')" class="btn-decline">Decline</span>
                        </td>
                    </tr>`;
                
                if (d.role === 'teacher') fTable.innerHTML += row;
                else sTable.innerHTML += row;
            });
        }

        window.updateStatus = async (uid, status) => {
            if (status === 'approved') {
                await updateDoc(doc(db, "users", uid), { status: "approved" });
                alert("Account Approved");
            } else {
                await deleteDoc(doc(db, "users", uid));
                alert("Request Declined");
            }
            loadRequests();
        };

        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
    </script>
</body>
</html>
