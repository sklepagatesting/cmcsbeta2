<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Class Assignment | CMCS VLS</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<style>
    .bg-cmcs-blue { background-color:#0070c0 }
    .bg-cmcs-sidebar { background-color:#00b0f0 }
    .bg-cmcs-yellow { background-color:#ffff00 }
    .bg-cmcs-logout { background-color:#cc0000 }

    .sidebar-link {
        padding:12px 20px;
        color:white;
        font-weight:bold;
        text-transform:uppercase;
        font-size:13px;
        border-bottom:1px solid rgba(255,255,255,.25);
        transition:.2s;
    }
    .sidebar-link:hover { background:#0096d6 }
    .active-tab { background:#ffff00;color:black }

    table { width:100%; border-collapse:collapse; font-size:11px }
    th { background:#d9d9d9; border:1px solid #7f7f7f; padding:6px; font-weight:bold }
    td { border:1px solid #7f7f7f; padding:6px; background:white; text-transform:uppercase }

    .filter-container {
        border:1px solid black;
        height:38px;
        display:flex;
        background:white;
    }
    .filter-box {
        flex:1;
        padding:0 8px;
        display:flex;
        flex-direction:column;
        justify-content:center;
        border-right:1px solid black;
    }
    .filter-label { font-size:9px;font-weight:bold;text-transform:uppercase }
    .filter-select { background:none;outline:none;font-size:11px;font-weight:bold }

    .tag-green {
        background:#00ff00;
        border:1px solid black;
        padding:1px 4px;
        font-size:10px;
        font-weight:bold;
    }

    .modal-overlay {
        position:fixed;
        inset:0;
        background:rgba(0,0,0,.6);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:100;
    }
    .modal-container {
        background:white;
        border:2px solid black;
        width:520px;
        box-shadow:6px 6px 0 black;
    }
    .modal-header {
        background:#0070c0;
        color:white;
        padding:10px;
        font-weight:bold;
        text-transform:uppercase;
        display:flex;
        justify-content:space-between;
    }

    .btn-modal-save {
        background:#ffff00;
        border:1px solid black;
        padding:6px 18px;
        font-size:10px;
        font-weight:bold;
        box-shadow:3px 3px 0 black;
    }
    .btn-modal-cancel {
        background:#d9d9d9;
        border:1px solid black;
        padding:6px 18px;
        font-size:10px;
        font-weight:bold;
    }

    .program-row {
        display:grid;
        grid-template-columns:30px 100px 1fr;
        padding:6px;
        border-bottom:1px solid #eee;
        align-items:center;
    }
</style>
</head>

<body class="min-h-screen flex flex-col font-sans">

<nav class="bg-cmcs-blue h-12 flex justify-between items-center text-white">
    <div class="px-4 font-bold uppercase text-sm">CMCS Virtual Learning System</div>
    <div class="flex items-center h-full">
        <span id="adminName" class="px-6 italic text-xs uppercase">Loading...</span>
        <button onclick="logout()" class="bg-cmcs-logout h-full px-8 font-bold text-xs uppercase">Logout</button>
    </div>
</nav>

<div class="flex flex-1">
<aside class="w-48 bg-cmcs-sidebar flex flex-col sidebar">
    <a class="sidebar-link" href="admin_approvalbeta.html">Approvals</a>
    <a class="sidebar-link" href="admin_setupbeta.html">Academic Setup</a>
    <a class="sidebar-link active-tab" href="#">Class Assignment</a>
    <a class="sidebar-link" href="admin_recordsbeta.html">Master Record</a>
    <a class="sidebar-link" href="admin_accountsbeta.html">Accounts</a>
</aside>

<main class="flex-1 p-6 page">
    <h2 class="text-xs font-bold uppercase border-b-2 border-black inline-block mb-4">Student List</h2>

    <div class="flex gap-4 mb-6 filters">
        <div class="filter-container flex-1">
            <div class="filter-box flex-[2]">
                <span class="filter-label">Course</span>
                <select id="filterCourse" class="filter-select"></select>
            </div>
            <div class="filter-box">
                <span class="filter-label">Year</span>
                <select id="filterYear" class="filter-select">
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                </select>
            </div>
            <div class="filter-box border-none">
                <span class="filter-label">Semester</span>
                <select id="filterSem" class="filter-select">
                    <option>1</option><option>2</option>
                </select>
            </div>
        </div>

        <div class="filter-container w-64">
            <div class="filter-box border-none">
                <span class="filter-label">Search</span>
                <input id="searchField" class="filter-select" placeholder="Name or ID" />
            </div>
        </div>

        <button id="fetchBtn"
            class="bg-cmcs-yellow border border-black px-10 font-bold text-xs uppercase shadow-[2px_2px_0_black]">
            Fetch
        </button>
    </div>

    <table>
        <thead>
            <tr>
                <th width="40">No</th>
                <th width="120">ID</th>
                <th>Lastname</th>
                <th>Firstname</th>
                <th width="160">Course/Yr/Sem</th>
                <th>Assigned Programs</th>
                <th width="120">Actions</th>
            </tr>
        </thead>
        <tbody id="studentTableBody">
            <tr><td colspan="7" class="p-6 text-center italic text-gray-400">Select filters and click Fetch</td></tr>
        </tbody>
    </table>
</main>
</div>

<!-- GSAP -->
<script>
gsap.from(".sidebar a", { x:-30, opacity:0, stagger:.08, duration:.5 });
gsap.from(".page", { opacity:0, y:20, duration:.5 });

document.getElementById("fetchBtn").addEventListener("click", () => {
    gsap.from("#studentTableBody tr", { opacity:0, y:10, stagger:.04, duration:.4 });
});

window.animateModalIn = el => {
    el.style.display="flex";
    gsap.fromTo(el.querySelector(".modal-container"),
        { scale:.8, opacity:0 },
        { scale:1, opacity:1, duration:.3, ease:"back.out(1.7)" });
};
window.animateModalOut = el => {
    gsap.to(el.querySelector(".modal-container"),
        { scale:.8, opacity:0, duration:.2, onComplete:()=>el.style.display="none" });
};
</script>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDaeNQF4qmW0vvwxUPp_NztnT0hoLzm1BQ",
            authDomain: "svls-289ee.firebaseapp.com",
            projectId: "svls-289ee",
            storageBucket: "svls-289ee.firebasestorage.app",
            messagingSenderId: "500705386198",
            appId: "1:500705386198:web:96f189662bc2aa99cf7377"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentStudentUid = null;
        let fetchedStudents = []; // Store data for search

        window.showNotif = (msg) => {
            document.getElementById('notifMessage').innerText = msg;
            document.getElementById('notifModal').style.display = 'flex';
        };

        window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    document.getElementById('adminName').innerText = `${snap.data().lastname}, ${snap.data().firstname}`.toUpperCase();
                    loadCourses();
                }
            } else { window.location.href = "login.html"; }
        });

        async function loadCourses() {
            const snap = await getDocs(collection(db, "courses"));
            const sel = document.getElementById('filterCourse');
            sel.innerHTML = '<option value="" disabled selected>SELECT COURSE</option>';
            snap.forEach(d => {
                const name = d.data().name.toUpperCase();
                sel.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }

        // Modified Render function to support filtering
        function renderTable(students) {
            const tbody = document.getElementById('studentTableBody');
            const sem = document.getElementById('filterSem').value;
            tbody.innerHTML = '';
            let count = 1;

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-600 font-bold">NO RECORDS MATCHED</td></tr>';
                return;
            }

            students.forEach(s => {
                const subjects = s.assignedPrograms ? s.assignedPrograms.map(p => `<span class="tag-green">${p}</span>`).join('') : '--';
                tbody.innerHTML += `
                    <tr>
                        <td>${count++}</td>
                        <td class="font-bold text-blue-800">${s.studentId || '00-0-000'}</td>
                        <td>${s.lastname}</td><td>${s.firstname}</td>
                        <td>${s.course} Y${s.year} S${sem}</td>
                        <td><div class="flex flex-wrap gap-1">${subjects}</div></td>
                        <td><button onclick="openClassModal('${s.uid}', '${s.lastname}, ${s.firstname}')" class="text-green-600 underline font-bold italic text-[10px]">UPDATE LOAD</button></td>
                    </tr>`;
            });
        }

        // Search Input Event
        document.getElementById('searchField').oninput = (e) => {
            const queryStr = e.target.value.toUpperCase();
            const filtered = fetchedStudents.filter(s => 
                s.lastname.toUpperCase().includes(queryStr) || 
                s.firstname.toUpperCase().includes(queryStr) || 
                (s.studentId && s.studentId.toUpperCase().includes(queryStr))
            );
            renderTable(filtered);
        };

        window.openClassModal = async (uid, name) => {
            currentStudentUid = uid;
            document.getElementById('targetStudentName').innerText = name;
            const listDiv = document.getElementById('programList');
            listDiv.innerHTML = '<div class="p-4 text-[10px] italic">Accessing database...</div>';
            document.getElementById('classModal').style.display = 'flex';

            try {
                const [progSnap, userSnap] = await Promise.all([
                    getDocs(collection(db, "programs")),
                    getDoc(doc(db, "users", uid))
                ]);
                const enrolled = userSnap.data().assignedPrograms || [];
                listDiv.innerHTML = '';
                progSnap.forEach(p => {
                    const data = p.data();
                    const pCode = (data.code || "").toUpperCase();
                    const pName = (data.name || "UNNAMED SUBJECT").toUpperCase();
                    const checked = enrolled.includes(pCode) ? 'checked' : '';
                    listDiv.innerHTML += `
                        <div class="program-row px-2">
                            <input type="checkbox" value="${pCode}" ${checked} class="prog-checkbox w-3 h-3 accent-blue-600">
                            <span class="text-[10px] font-bold text-blue-900 border-r pr-2">${pCode}</span>
                            <span class="text-[10px] font-medium pl-1">${pName}</span>
                        </div>`;
                });
            } catch (err) { listDiv.innerHTML = 'Error loading subjects.'; }
        };

        document.getElementById('fetchBtn').onclick = async () => {
            const course = document.getElementById('filterCourse').value;
            const year = document.getElementById('filterYear').value;
            const sem = document.getElementById('filterSem').value;
            const tbody = document.getElementById('studentTableBody');
            
            if(!course) { showNotif("PLEASE SELECT A COURSE FIRST"); return; }
            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center italic">Fetching students...</td></tr>';

            try {
                const q = query(collection(db, "users"), 
                    where("role", "==", "student"),
                    where("status", "==", "approved"),
                    where("course", "==", course),
                    where("year", "==", year)
                );

                const snap = await getDocs(q);
                fetchedStudents = [];
                
                snap.forEach(u => {
                    const d = u.data();
                    if (!d.semester || d.semester == sem) {
                        fetchedStudents.push({ uid: u.id, ...d });
                    }
                });
                
                renderTable(fetchedStudents);
                document.getElementById('searchField').value = ''; // Reset search box on new fetch
            } catch (e) { showNotif("ERROR CONNECTING TO DATABASE"); }
        };

        document.getElementById('saveClassesBtn').onclick = async () => {
            const selected = Array.from(document.querySelectorAll('.prog-checkbox:checked')).map(cb => cb.value);
            const btn = document.getElementById('saveClassesBtn');
            btn.disabled = true;
            btn.innerText = "SAVING...";

            try {
                await updateDoc(doc(db, "users", currentStudentUid), { assignedPrograms: selected });
                closeModal('classModal');
                showNotif("STUDENT SUBJECT LOAD UPDATED SUCCESSFULLY");
                document.getElementById('fetchBtn').click(); 
            } catch (err) { showNotif("SAVE FAILED. CHECK NETWORK."); }
            finally { btn.disabled = false; btn.innerText = "SAVE RECORD"; }
        };

        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
    </script>

</body>
      </html>
