<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Assignment | CMCS VLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563eb',
                        secondary: '#1e293b',
                        accent: '#f59e0b',
                        danger: '#ef4444',
                        success: '#10b981'
                    }
                }
            }
        }
    </script>
    <style>
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #2563eb; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .prog-checkbox:checked + span { color: #2563eb; font-weight: 700; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex overflow-hidden">
    <aside class="w-64 bg-secondary text-white flex flex-col shadow-2xl z-20">
        <div class="h-16 flex items-center px-6 border-b border-gray-700 bg-slate-900">
            <div class="font-bold text-lg tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-graduation-cap text-primary"></i> CMCS <span class="text-primary">VLS</span>
            </div>
        </div>
        <nav class="flex-1 py-6 px-3 space-y-1 overflow-y-auto">
            <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Main Menu</p>
            <a href="admin_approvalbeta.html" class="flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                <i class="fa-solid fa-check-to-slot w-5"></i> <span class="font-medium text-sm">Approvals</span>
            </a>
            <a href="admin_setupbeta.html" class="flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                <i class="fa-solid fa-school w-5"></i> <span class="font-medium text-sm">Academic Setup</span>
            </a>
            <a href="admin_classbeta.html" class="flex items-center gap-3 px-3 py-3 rounded-lg bg-primary text-white shadow-md transition-colors">
                <i class="fa-solid fa-chalkboard-user w-5"></i> <span class="font-medium text-sm">Class Assignment</span>
            </a>
            <a href="admin_recordsbeta.html" class="flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                <i class="fa-solid fa-folder-open w-5"></i> <span class="font-medium text-sm">Master Record</span>
            </a>
            <a href="admin_accountsbeta.html" class="flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                <i class="fa-solid fa-users-gear w-5"></i> <span class="font-medium text-sm">Accounts</span>
            </a>
        </nav>
        <div class="p-4 border-t border-gray-700 bg-slate-900">
    <a href="admin_edit.html" class="flex items-center gap-3 mb-3 p-2 rounded-lg hover:bg-white/5 transition-all group">
        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-sm font-bold text-white uppercase group-hover:ring-2 ring-primary ring-offset-2 ring-offset-slate-900 transition-all" id="adminInitial">
            AD
        </div>
        <div class="flex-1 min-w-0">
            <p class="text-xs font-bold text-white truncate uppercase tracking-tight" id="adminName">Loading...</p>
            <p class="text-[10px] text-gray-400 uppercase flex items-center gap-1">
                <i class="fa-solid fa-gear text-[8px]"></i> Account Settings
            </p>
        </div>
        <i class="fa-solid fa-chevron-right text-gray-600 text-[10px] group-hover:text-white"></i>
    </a>
    
    <button onclick="logout()" class="w-full flex items-center justify-center gap-2 bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white py-2 rounded-md text-xs font-bold transition-all uppercase tracking-widest">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
</div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="h-16 bg-white shadow-sm flex items-center justify-between px-8 z-10">
            <h1 class="text-xl font-bold text-gray-800">Class Assignment</h1>
            <div class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full flex items-center gap-2">
                <span class="w-2 h-2 bg-success rounded-full animate-pulse"></span> Enrollment Live
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1 tracking-widest">Target Course</label>
                        <select id="filterCourse" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-semibold"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1 tracking-widest">Year</label>
                            <select id="filterYear" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-semibold">
                                <option value="1">1ST YEAR</option>
                                <option value="2">2ND YEAR</option>
                                <option value="3">3RD YEAR</option>
                                <option value="4">4TH YEAR</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1 tracking-widest">Semester</label>
                            <select id="filterSem" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-semibold">
                                <option value="1ST SEMESTER">1ST SEMESTER</option>
                                <option value="2ND SEMESTER">2ND SEMESTER</option>
                                <option value="SUMMER">SUMMER</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1 tracking-widest">Quick Search</label>
                        <div class="relative">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-300 text-xs"></i>
                            <input type="text" id="searchField" class="w-full bg-gray-50 border border-gray-200 rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none uppercase font-medium" placeholder="ID OR SURNAME...">
                        </div>
                    </div>
                    <button id="fetchBtn" class="bg-primary hover:bg-blue-700 text-white h-[38px] rounded-lg text-xs font-bold shadow-md transition-all flex items-center justify-center gap-2 uppercase tracking-wide">
                        <i class="fa-solid fa-sync-alt"></i> Fetch Students
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-400 text-[10px] uppercase font-bold tracking-widest">
                            <tr>
                                <th class="px-6 py-4" width="60">No.</th>
                                <th class="px-6 py-4">Student ID</th>
                                <th class="px-6 py-4">Full Name</th>
                                <th class="px-6 py-4">Academic Level</th>
                                <th class="px-6 py-4">Assigned Programs</th>
                                <th class="px-6 py-4 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="divide-y divide-gray-100 text-sm">
                            <tr><td colspan="6" class="px-6 py-12 text-center text-gray-400 italic">Select criteria and click fetch to load data.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="notifModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-info-circle text-xl"></i>
            </div>
            <h3 class="text-sm font-bold text-gray-800 uppercase mb-2 tracking-wide">System Message</h3>
            <p id="notifMessage" class="text-xs text-gray-500 mb-6 leading-relaxed px-2"></p>
            <button onclick="closeModal('notifModal')" class="w-full bg-secondary text-white py-2.5 rounded-lg text-xs font-bold hover:bg-slate-800 transition uppercase tracking-widest">Okay</button>
        </div>
    </div>

    <div id="classModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh]">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i class="fa-solid fa-book-open"></i></div>
                    <span class="font-bold text-gray-800 text-sm uppercase tracking-wide">Enrollment Load Manager</span>
                </div>
                <button onclick="closeModal('classModal')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-5 p-4 bg-primary/5 rounded-xl border border-primary/10">
                    <p class="text-[9px] font-black text-primary uppercase mb-1 tracking-tighter">Enrollment Target for:</p>
                    <p id="targetStudentName" class="text-sm font-black text-gray-800 uppercase"></p>
                    <div id="targetStudentSubInfo" class="text-[10px] text-gray-500 font-bold mt-1 uppercase"></div>
                </div>
                <div class="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
                    <div class="grid grid-cols-[45px_100px_1fr] gap-4 px-5 py-3 bg-gray-100 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                        <span>Check</span><span>Code</span><span>Subject & Schedule</span>
                    </div>
                    <div id="programList" class="divide-y divide-gray-100 bg-white"></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeModal('classModal')" class="px-6 py-2 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200 transition uppercase">Cancel</button>
                <button id="saveClassesBtn" class="px-8 py-2 rounded-lg text-xs font-bold text-white bg-success hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition flex items-center gap-2 uppercase tracking-wide">
                    <i class="fa-solid fa-check-circle"></i> Update Load
                </button>
            </div>
        </div>
    </div>
<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
    getFirestore, collection, onSnapshot, query, where, 
    deleteDoc, doc, getDoc, updateDoc, addDoc, getDocs, setDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { 
    getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = { 
    apiKey: "AIzaSyDaeNQF4qmW0vvwxUPp_NztnT0hoLzm1BQ",
    authDomain: "svls-289ee.firebaseapp.com",
    projectId: "svls-289ee",
    storageBucket: "svls-289ee.firebasestorage.app",
    messagingSenderId: "500705386198",
    appId: "1:500705386198:web:96f189662bc2aa99cf7377"
};

// Main App for Admin Session
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Secondary App for Background User Creation (Prevents Admin Logout)
const secondaryApp = initializeApp(firebaseConfig, "SecondaryAuthInstance");
const secondaryAuth = getAuth(secondaryApp);

let currentStudentUid = null;
let fetchedStudents = [];

// --- UTILITIES ---

// Real-time Clock
setInterval(() => {
    const clockEl = document.getElementById('clock');
    if(clockEl) {
        const now = new Date();
        clockEl.innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
}, 1000);

// ID Number Auto-formatter (00-0-000)
const idNumInput = document.getElementById('id_num');
if(idNumInput) {
    idNumInput.addEventListener('input', (e) => {
        let val = e.target.value.replace(/\D/g, ''); 
        if (val.length > 2 && val.length <= 3) val = val.slice(0, 2) + '-' + val.slice(2);
        else if (val.length > 3) val = val.slice(0, 2) + '-' + val.slice(2, 3) + '-' + val.slice(3, 6);
        e.target.value = val;
    });
}

window.calculateAge = (dateString) => {
    if(!dateString) return "";
    const today = new Date();
    const birthDate = new Date(dateString);
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
};

// --- AUTH & ACCESS CONTROL ---

onAuthStateChanged(auth, async (user) => {
    if (user) {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists() && snap.data().role === 'admin') {
            const data = snap.data();
            const adminNameEl = document.getElementById('adminName');
            if(adminNameEl) adminNameEl.innerText = `${data.lastname}, ${data.firstname}`.toUpperCase();
            
            // Initialize page-specific data
            if(document.getElementById('studentTable')) startApprovalListeners();
            if(document.getElementById('filterCourse')) loadCourses();
        } else {
            window.location.href = "login.html"; 
        }
    } else { 
        window.location.href = "login.html"; 
    }
});

// --- MANUAL ADMISSION (CREATING AUTH ACCOUNTS) ---

window.openAddModal = (role) => {
    document.getElementById('userRole').value = role;
    document.getElementById('modalTitle').innerText = role === 'student' ? 'Manual Student Admission' : 'Manual Faculty Hiring';
    document.getElementById('studentFields').style.display = role === 'student' ? 'block' : 'none';
    document.getElementById('facultyFields').style.display = role === 'teacher' ? 'block' : 'none';
    
    const modal = document.getElementById('userModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
};

const userForm = document.getElementById('userForm');
if(userForm) {
    userForm.onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveUserBtn');
        const email = document.getElementById('uemail').value.trim().toLowerCase();
        const password = "ChangeMe2026!"; 

        btn.disabled = true;
        btn.innerHTML = 'PROCESSING AUTH...';

        try {
            // 1. Create the official Firebase Auth Account
            const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
            const newUser = userCred.user;

            // 2. Immediately logout the secondary instance so admin stays logged in
            await signOut(secondaryAuth);

            // 3. Prepare Firestore Record using the new UID
            const userData = {
                uid: newUser.uid,
                firstname: document.getElementById('fn').value.toUpperCase(),
                lastname: document.getElementById('ln').value.toUpperCase(),
                gender: document.getElementById('gender').value.toUpperCase(),
                birthdate: document.getElementById('bday').value,
                address: document.getElementById('address').value.toUpperCase(),
                email: email,
                role: document.getElementById('userRole').value,
                status: "approved",
                createdAt: new Date()
            };

            if(userData.role === 'student') {
                userData.studentId = document.getElementById('id_num').value.toUpperCase();
                userData.course = document.getElementById('ucourse').value.toUpperCase();
                userData.year = document.getElementById('uyear').value.toUpperCase();
                userData.semester = document.getElementById('usemester').value.toUpperCase();
            } else {
                userData.license = document.getElementById('license').value.toUpperCase();
                userData.designation = "FACULTY";
            }

            // 4. Save to Firestore
            await setDoc(doc(db, "users", newUser.uid), userData);
            
            closeModal('userModal');
            showNotif(`ACCOUNT CREATED IN AUTH: Use ${password} to login.`);
            userForm.reset();

        } catch (err) {
            showNotif("Error: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'SAVE RECORD';
        }
    };
}

// --- CLASS ASSIGNMENT LOGIC ---

async function loadCourses() {
    const snap = await getDocs(collection(db, "course")); // Collection name from admin_setup
    const sel = document.getElementById('filterCourse');
    const uSel = document.getElementById('ucourse'); // Manual modal select
    
    const options = '<option value="" disabled selected>-- SELECT COURSE --</option>' + 
        Array.from(snap.docs).map(d => `<option value="${d.data().name.toUpperCase()}">${d.data().name.toUpperCase()}</option>`).join('');
    
    if(sel) sel.innerHTML = options;
    if(uSel) uSel.innerHTML = options;
}

const fetchBtn = document.getElementById('fetchBtn');
if(fetchBtn) {
    fetchBtn.onclick = async () => {
        const course = document.getElementById('filterCourse').value;
        const year = document.getElementById('filterYear').value;
        const sem = document.getElementById('filterSem').value;
        
        if(!course) return showNotif("SELECT COURSE FIRST");

        const q = query(collection(db, "users"), 
            where("role", "==", "student"),
            where("status", "==", "approved"),
            where("course", "==", course),
            where("year", "==", year)
        );

        const snap = await getDocs(q);
        fetchedStudents = [];
        snap.forEach(u => {
            const d = u.data();
            if(!d.semester || d.semester == sem) fetchedStudents.push({ uid: u.id, ...d });
        });
        renderTable(fetchedStudents);
    };
}

function renderTable(students) {
    const tbody = document.getElementById('studentTableBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    
    students.forEach(s => {
        const subjects = s.assignedPrograms ? s.assignedPrograms.map(p => `<span class="tag-green">${p}</span>`).join('') : '--';
        tbody.innerHTML += `
            <tr>
                <td>${s.studentId || 'NO-ID'}</td>
                <td class="font-bold">${s.lastname}, ${s.firstname}</td>
                <td>${s.course} Y${s.year}</td>
                <td><div class="flex flex-wrap gap-1">${subjects}</div></td>
                <td><button onclick="openClassModal('${s.uid}', '${s.lastname}, ${s.firstname}')" class="text-blue-600 underline font-bold italic text-[10px]">UPDATE LOAD</button></td>
            </tr>`;
    });
}

window.openClassModal = async (uid, name) => {
    currentStudentUid = uid;
    document.getElementById('targetStudentName').innerText = name;
    const listDiv = document.getElementById('programList');
    listDiv.innerHTML = '<div class="p-4 text-center">Loading Subjects...</div>';
    document.getElementById('classModal').style.display = 'flex';

    const [progSnap, userSnap] = await Promise.all([
        getDocs(collection(db, "programs")),
        getDoc(doc(db, "users", uid))
    ]);

    const enrolled = userSnap.data().assignedPrograms || [];
    listDiv.innerHTML = '';
    
    progSnap.forEach(p => {
        const data = p.data();
        const isInactive = data.status === 'INACTIVE';
        const checked = enrolled.includes(data.code) ? 'checked' : '';
        
        listDiv.innerHTML += `
            <div class="program-row ${isInactive ? 'bg-red-50' : ''}">
                <input type="checkbox" value="${data.code}" ${checked} class="prog-checkbox">
                <span class="font-bold ${isInactive ? 'text-red-600' : 'text-blue-800'}">${data.code}</span>
                <span class="text-gray-600">${data.name} ${isInactive ? '(INACTIVE)' : ''}</span>
            </div>`;
    });
};

const saveClassesBtn = document.getElementById('saveClassesBtn');
if(saveClassesBtn) {
    saveClassesBtn.onclick = async () => {
        const selected = Array.from(document.querySelectorAll('.prog-checkbox:checked')).map(cb => cb.value);
        try {
            await updateDoc(doc(db, "users", currentStudentUid), { assignedPrograms: selected });
            closeModal('classModal');
            showNotif("SUBJECT LOAD UPDATED");
            document.getElementById('fetchBtn').click();
        } catch (e) { showNotif("SAVE FAILED"); }
    };
}

// --- SYSTEM MODALS ---

window.showNotif = (msg, isConfirm = false, onYes = null) => {
    const modal = document.getElementById('notifModal');
    if(!modal) return alert(msg);
    
    document.getElementById('notifMessage').innerText = msg;
    const confirmDiv = document.getElementById('confirmActions');
    const alertDiv = document.getElementById('alertActions');

    if (isConfirm) {
        confirmDiv.classList.remove('hidden');
        alertDiv.classList.add('hidden');
        document.getElementById('btnYes').onclick = () => { onYes(); closeModal('notifModal'); };
    } else {
        if(confirmDiv) confirmDiv.classList.add('hidden');
        if(alertDiv) alertDiv.classList.remove('hidden');
    }
    modal.style.display = 'flex';
};

window.closeModal = (id) => {
    document.getElementById(id).style.display = 'none';
};

window.logout = () => {
    signOut(auth).then(() => window.location.href = "login.html");
};
</script>
