<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts Management | CMCS VLS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        cmcs: {
                            sidebar: '#0f172a',
                            active: '#3b82f6',
                            danger: '#ef4444'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* DASHBOARD UI STYLES */
        body { background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 1px solid #e2e8f0; }
        .sidebar-link { transition: all 0.2s; border-radius: 8px; margin: 4px 12px; padding: 10px 16px; display: flex; align-items: center; color: #94a3b8; font-weight: 500; font-size: 13px; }
        .sidebar-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .active-tab { background: #3b82f6 !important; color: white !important; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .modern-table th { background: #f1f5f9; color: #475569; padding: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; }
        .modern-table td { padding: 12px; background: white; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #1e293b; }

        /* LEGACY PRINT ENGINE */
        #printHeader { display: none; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0; margin: 0; }
            table { width: 100% !important; border-collapse: collapse !important; font-family: 'Times New Roman', serif; }
            th { background-color: #d9d9d9 !important; border: 1px solid black !important; color: black !important; font-size: 10pt !important; }
            td { border: 1px solid black !important; background: white !important; font-size: 9pt !important; text-transform: uppercase !important; }
            #printHeader { display: block !important; text-align: center; margin-bottom: 20px; }
        }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.8); position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-container { background: white; border-radius: 12px; width: 500px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

    <nav class="bg-white border-b border-gray-200 h-16 flex justify-between items-center px-8 z-30 no-print">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">C</div>
            <span class="font-bold text-gray-800 tracking-tight">CMCS <span class="text-blue-600 text-sm">ACCOUNTS</span></span>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <p class="text-xs font-bold text-gray-800 uppercase" id="adminName">Loading...</p>
                <p class="text-[10px] text-gray-500 uppercase">System Administrator</p>
            </div>
            <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-md text-xs font-bold hover:bg-red-600 hover:text-white transition-all">Logout</button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-cmcs-sidebar flex flex-col pt-4 no-print">
            <a href="admin_approval.html" class="sidebar-link"><span>Approvals</span></a>
            <a href="admin_setup.html" class="sidebar-link"><span>Academic Setup</span></a>
            <a href="admin_class.html" class="sidebar-link"><span>Class Assignment</span></a>
            <a href="admin_records.html" class="sidebar-link"><span>Master Record</span></a>
            <a href="admin_accounts.html" class="sidebar-link active-tab"><span>Accounts</span></a>
        </aside>

        <main class="flex-1 overflow-y-auto p-8">
            <div id="printHeader">
                <h1 class="font-bold text-xl">CENTRAL MINDANAO COMPUTER SCHOOL</h1>
                <p class="text-sm uppercase font-bold">Official User Accounts Directory</p>
                <hr class="border-black my-2">
            </div>

            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-8 no-print">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Account Management</h2>
                        <p class="text-sm text-gray-500">Manage user access, roles, and security status</p>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6 mb-8 no-print flex items-center gap-6">
                    <div class="w-48">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">View Role</label>
                        <select id="roleFilter" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm font-semibold text-gray-700 outline-none">
                            <option value="ALL">All Roles</option>
                            <option value="student">Students</option>
                            <option value="teacher">Teachers</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Search User</label>
                        <input type="text" id="userSearch" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm font-medium outline-none" placeholder="Search by name or ID...">
                    </div>
                </div>

                <div class="glass-card rounded-2xl overflow-hidden shadow-sm">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th width="140">User ID / Role</th>
                                <th>Full Name</th>
                                <th>Email Address</th>
                                <th>Department</th>
                                <th width="100">Status</th>
                                <th width="220" class="no-print text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-container">
            <div class="bg-gray-900 text-white p-4 font-bold text-xs flex justify-between uppercase">
                <span>Edit User Profile</span>
                <button onclick="closeModal('editModal')">X</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editUid">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">First Name</label>
                    <input type="text" id="editFirst" class="w-full border p-2 rounded text-sm uppercase">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Last Name</label>
                    <input type="text" id="editLast" class="w-full border p-2 rounded text-sm uppercase">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Course / Dept</label>
                    <input type="text" id="editDept" class="w-full border p-2 rounded text-sm uppercase">
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="saveUser()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold text-xs uppercase shadow-lg">Save Changes</button>
                    <button onclick="closeModal('editModal')" class="flex-1 bg-gray-100 py-2 rounded font-bold text-xs uppercase">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, doc, updateDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDaeNQF4qmW0vvwxUPp_NztnT0hoLzm1BQ",
            authDomain: "svls-289ee.firebaseapp.com",
            projectId: "svls-289ee",
            storageBucket: "svls-289ee.firebasestorage.app",
            messagingSenderId: "500705386198",
            appId: "1:500705386198:web:96f189662bc2aa99cf7377"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allUsers = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    document.getElementById('adminName').innerText = `${snap.data().lastname}, ${snap.data().firstname}`.toUpperCase();
                    syncUsers();
                }
            } else { window.location.href = "login.html"; }
        });

        function syncUsers() {
            onSnapshot(collection(db, "users"), (snap) => {
                allUsers = [];
                snap.forEach(d => allUsers.push({ uid: d.id, ...d.data() }));
                renderTable();
            });
        }

        function renderTable() {
            const role = document.getElementById('roleFilter').value;
            const search = document.getElementById('userSearch').value.toUpperCase();
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            const filtered = allUsers.filter(u => {
                const matchRole = role === 'ALL' || u.role === role;
                const fullName = `${u.lastname} ${u.firstname}`.toUpperCase();
                const matchSearch = fullName.includes(search) || (u.studentId && u.studentId.includes(search));
                return matchRole && matchSearch && u.role !== 'admin';
            });

            filtered.forEach(u => {
                const isActive = u.status === 'approved';
                const dept = u.role === 'student' ? u.course : 'FACULTY';

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="font-bold text-gray-800">${u.studentId || 'N/A'}</div>
                            <div class="text-[10px] text-blue-500 font-bold uppercase tracking-wider">${u.role}</div>
                        </td>
                        <td class="font-bold uppercase">${u.lastname}, ${u.firstname}</td>
                        <td class="text-gray-500 lowercase text-[12px]">${u.email}</td>
                        <td class="uppercase font-bold text-gray-400 text-[11px]">${dept || '---'}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-[10px] font-bold ${isActive ? 'bg-green-50 text-green-600 border border-green-100' : 'bg-red-50 text-red-600 border border-red-100'}">
                                ${isActive ? 'ACTIVE' : 'BLOCKED'}
                            </span>
                        </td>
                        <td class="no-print">
                            <div class="flex gap-2 justify-center">
                                <button onclick="openEdit('${u.uid}')" class="bg-gray-800 text-white px-3 py-1.5 rounded text-[10px] font-bold hover:bg-blue-600">EDIT</button>
                                <button onclick="toggleBlock('${u.uid}', '${u.status}')" class="border border-gray-200 px-3 py-1.5 rounded text-[10px] font-bold hover:bg-gray-50">
                                    ${isActive ? 'BLOCK' : 'UNBLOCK'}
                                </button>
                                <button onclick="deleteUser('${u.uid}')" class="bg-red-50 text-red-600 px-3 py-1.5 rounded text-[10px] font-bold hover:bg-red-600 hover:text-white">DELETE</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        window.openEdit = (uid) => {
            const u = allUsers.find(x => x.uid === uid);
            document.getElementById('editUid').value = uid;
            document.getElementById('editFirst').value = u.firstname;
            document.getElementById('editLast').value = u.lastname;
            document.getElementById('editDept').value = (u.role === 'student' ? u.course : 'FACULTY');
            document.getElementById('editModal').style.display = 'flex';
        };

        window.saveUser = async () => {
            const uid = document.getElementById('editUid').value;
            const u = allUsers.find(x => x.uid === uid);
            const updateData = {
                firstname: document.getElementById('editFirst').value.toUpperCase(),
                lastname: document.getElementById('editLast').value.toUpperCase()
            };
            if(u.role === 'student') updateData.course = document.getElementById('editDept').value.toUpperCase();
            
            await updateDoc(doc(db, "users", uid), updateData);
            closeModal('editModal');
        };

        window.toggleBlock = async (uid, currentStatus) => {
            const newStatus = currentStatus === 'approved' ? 'disabled' : 'approved';
            if(confirm(`ARE YOU SURE YOU WANT TO ${newStatus === 'disabled' ? 'BLOCK' : 'UNBLOCK'} THIS USER?`)) {
                await updateDoc(doc(db, "users", uid), { status: newStatus });
            }
        };

        window.deleteUser = async (uid) => {
            if(confirm("PERMANENTLY DELETE THIS USER? THIS ACTION CANNOT BE UNDONE.")) {
                await deleteDoc(doc(db, "users", uid));
            }
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        document.getElementById('roleFilter').onchange = renderTable;
        document.getElementById('userSearch').oninput = renderTable;
        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
    </script>
</body>
</html>
